# JSON Formatter Chrome 扩展 - 使用指南

## 概述

JSON Formatter 是一个 Chrome 扩展程序（Manifest V3），能够自动将浏览器中的原始 JSON 内容转换为美观、易读的视图，提供语法高亮、折叠功能、行号显示和一键复制等功能。

**核心特性：**
- 零构建安装（无需 npm/webpack）
- 自动检测原始 JSON 页面
- 智能格式化（2 空格缩进）
- 轻量级语法高亮（无外部依赖）
- 可折叠的对象和数组
- 自动更新的行号
- 一键复制 JSON
- 性能优化和加载状态

## 安装

### 步骤详解

1. **下载扩展**
   - 将项目代码下载到本地计算机
   - 或将代码仓库克隆到您的计算机

2. **访问 Chrome 扩展页面**
   - 打开 Chrome 浏览器
   - 导航到 `chrome://extensions`

3. **启用开发者模式**
   - 确保右上角的"开发者模式"开关已启用

4. **加载扩展**
   - 点击"加载已解压的扩展程序"按钮
   - 选择包含项目文件的文件夹（包含 `manifest.json` 的目录）

5. **验证安装**
   - "JSON Formatter" 扩展应该已安装并激活

### 文件 URL 访问

如果您需要格式化本地 JSON 文件（`file://` 协议）：
1. 进入 `chrome://extensions`
2. 找到 JSON Formatter 扩展
3. 点击"详细信息"
4. 启用"允许访问文件网址"

## 工作原理

### 技术实现

1. **内容脚本加载**：`content.js` 在 `document_start`（早期页面加载）时运行
2. **智能检测**：使用两种方法识别原始 JSON 页面：
   - 包含单个 `<pre>` 元素的页面（典型的 Chrome JSON 显示）
   - 具有 JSON `Content-Type` 头的页面
3. **安全解析**：使用 `JSON.parse()` 验证 JSON 内容
4. **Shadow DOM 渲染**：使用 Shadow DOM 创建隔离的 UI，实现样式封装
5. **基于事件的交互**：所有交互（折叠、复制）都使用正确的事件监听器

### 性能优化

- **早期介入**：在 `document_start` 运行，防止原始 JSON 闪烁
- **加载状态**：在渲染前显示轻量级加载指示器
- **智能模式切换**：大型 JSON 默认使用"纯文本模式"以提高速度
- **手动模式切换**：用户可以在需要时手动启用折叠模式

## 使用方法

### 自动格式化

安装后，扩展会自动工作：
1. 打开任何原始 JSON 页面
2. 短暂显示加载指示器
3. 渲染格式化的 JSON，包含高亮、行号和可折叠部分

### 界面组件

#### 主控制按钮（JSON 卡片右上角）
- **展开全部**：展开所有折叠的部分
- **折叠全部**：折叠所有对象和数组
- **折叠1级/2级/3级**：按特定深度级别折叠
- **复制 JSON**：将格式化的 JSON 复制到剪贴板

#### 单节点控制
- **单节点折叠**：点击 `-` 折叠对象/数组，点击 `+` 展开
- **状态指示器**：
  - 折叠的对象显示：`... X 个属性`
  - 折叠的数组显示：`... X 项`

### 折叠功能

#### 控制按钮
位于 JSON 显示卡片的右上角：

- **展开全部**：完全展开所有折叠的部分
- **折叠全部**：将所有对象和数组折叠到顶级
- **折叠1/2/3级**：按深度级别渐进折叠

#### 手动节点控制
- 点击对象/数组前的 `-` 图标折叠特定节点
- 点击 `+` 图标展开折叠的节点
- 折叠的节点显示摘要信息（如 `... 5 个属性`）

### 复制功能

- **复制 JSON 按钮**：将当前格式化的 JSON（2 空格缩进）复制到剪贴板
- **格式保持**：复制保持 2 空格缩进以确保一致性

### 性能模式

#### 标准模式（小型 JSON 默认）
- 完整的高亮、行号和折叠功能
- 可用的交互控制

#### 纯文本模式（大型 JSON 默认）
- 对于非常大的文件更快渲染
- 纯文本显示，无交互功能
- **手动切换**："启用折叠"按钮允许在需要时切换到交互模式

## 隐私与权限

### 所需权限

- **主机权限**：`<all_urls>` - 允许内容脚本在所有网页上运行
- **目的**：在不同域之间启用 JSON 的检测和格式化

### 隐私承诺

- **无网络请求**：扩展不会将数据发送到外部服务器
- **本地处理**：所有 JSON 解析和渲染都在页面内本地完成
- **无数据存储**：扩展不会存储或跟踪任何用户数据

## 测试与验证

### 手动测试步骤

1. **安装扩展**
   - 通过 `chrome://extensions` 在 Chrome 中加载扩展
   - 验证"JSON Formatter"出现在扩展列表中

2. **测试本地 JSON**
   ```bash
   # 启动本地服务器
   python3 -m http.server 8000
   # 在浏览器中访问
   http://localhost:8000/test.json
   ```

3. **验证清单**
   - ✅ JSON 显示正确的格式和高亮
   - ✅ 行号可见且准确
   - ✅ 折叠/展开按钮正常工作
   - ✅ "复制 JSON" 按钮功能正常
   - ✅ 大型 JSON 显示适当的性能模式

4. **错误处理测试**
   - 使用无效 JSON 测试以确保无误报
   - 验证常规 HTML 页面不受影响

### 调试信息

- **控制台日志**：打开 DevTools 控制台查看 `JSON Formatter Content Script Loaded...` 消息
- **扩展重载**：代码更改后，在 `chrome://extensions` 中点击"重载"按钮

## 开发

### 项目结构

```
chrome-ext-json-formatter/
├── manifest.json       # 扩展配置 (MV3)
├── content.js         # 主要内容脚本
├── test.json          # 测试用示例 JSON
├── README.md          # 原始文档
└── USER_GUIDE.md      # 本知识库
```

### 无构建流程

- **直接编辑**：直接修改 `content.js` 和 `manifest.json`
- **即时更新**：扩展重载后立即反映更改
- **无依赖**：无需 npm、webpack 或构建工具

### 调试技巧

1. **控制台输出**：检查 DevTools 控制台中的扩展消息
2. **扩展重载**：代码更改后始终重载扩展
3. **测试页面**：使用 `test.json` 进行一致测试
4. **开发者工具**：利用 Chrome DevTools 进行 DOM 检查

## 故障排除

### 常见问题

#### 1. 本地文件不工作

**问题**：`file://` URL 不触发格式化

**解决方案**：
- 进入 `chrome://extensions`
- 找到 JSON Formatter 扩展
- 点击"详细信息"
- 启用"允许访问文件网址"

#### 2. 页面未被格式化

**问题**：某些 JSON 页面保持未格式化状态

**说明**：扩展使用保守检测以避免干扰常规网页：
- 仅处理纯 JSON 页面（单个 `<pre>` 或 JSON content-type）
- 不会格式化嵌入在 HTML 外壳内的 JSON
- 防止在常规网站上出现误报

#### 3. 大型 JSON 性能问题

**问题**：非常大的 JSON 文件导致浏览器变慢

**解决方案**：
- 扩展会自动为大型文件切换到"纯文本模式"
- 仅在需要交互功能时使用"启用折叠"按钮
- 对于极大文件（>10MB）考虑使用外部 JSON 工具

### 性能考虑

- **大型 JSON 处理**：自动模式切换防止浏览器冻结
- **内存使用**：格式化显示比纯文本使用更多内存
- **响应时间**：非常大的文件可能需要更长时间初始渲染

## 最佳实践

### 最佳使用方式

1. **对于中小型 JSON**（< 1MB）：
   - 自动全功能模式提供最佳体验
   - 所有交互功能可用

2. **对于大型 JSON**（> 1MB）：
   - 使用纯文本模式进行初始查看
   - 仅在导航结构时启用折叠
   - 使用行号作为参考

3. **对于开发**：
   - 启用文件 URL 访问进行本地测试
   - 使用浏览器 DevTools 进行调试
   - 测试各种 JSON 大小

### 键盘快捷键

目前，所有交互都是基于鼠标的。未来版本可能包含面向高级用户的键盘快捷键。

## 支持与反馈

对于问题、功能请求或疑问：
1. 首先查看本知识库
2. 查看原始 README.md
3. 使用提供的 `test.json` 文件进行测试
4. 使用 Chrome DevTools 进行调试

## 版本信息

- **清单版本**：3 (MV3)
- **Chrome 兼容性**：所有现代 Chrome 版本
- **无构建系统**：支持直接文件编辑
- **轻量级**：无外部依赖或重型库

---

*本指南涵盖了 JSON Formatter Chrome 扩展的所有方面。有关技术实现细节，请参考原始 README.md 和源代码注释。*